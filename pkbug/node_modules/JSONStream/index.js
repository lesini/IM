#! /usr/bin/env node
"use strict";function check(e,t){return"string"==typeof e?t==e:e&&"function"==typeof e.exec?e.exec(t):"boolean"==typeof e?e:"function"==typeof e?e(t):!1}var Parser=require("jsonparse"),through=require("through");exports.parse=function(e,t){var n=new Parser,r=through(function(e){"string"==typeof e&&(e=new Buffer(e)),n.write(e)},function(e){e&&r.write(e),r.queue(null)});"string"==typeof e&&(e=e.split(".").map(function(e){return"*"===e?!0:""===e?{recurse:!0}:e}));var u=0;return e&&e.length||(e=null),n.onValue=function(n){if(this.root||(r.root=n),e){for(var i=0,s=0;i<e.length;){var o,c=e[i];if(s++,c&&!c.recurse){if(o=s===this.stack.length?this:this.stack[s],!o)return;if(!check(c,o.key))return;i++}else{i++;var l=e[i];if(!l)return;for(;;){if(o=s===this.stack.length?this:this.stack[s],!o)return;if(check(l,o.key)){i++,this.stack[s].value=null;break}s++}}}if(s===this.stack.length){u++;var a=this.stack.slice(1).map(function(e){return e.key}).concat([this.key]),f=this.value[this.key];null!=f&&null!=(f=t?t(f,a):f)&&r.queue(f),delete this.value[this.key];for(var h in this.stack)this.stack[h].value=null}}},n._onToken=n.onToken,n.onToken=function(t,i){n._onToken(t,i),0===this.stack.length&&r.root&&(e||r.queue(r.root),u=0,r.root=null)},n.onError=function(e){e.message.indexOf("at position")>-1&&(e.message="Invalid JSON ("+e.message+")"),r.emit("error",e)},r},exports.stringify=function(e,t,n,r){r=r||0,e===!1?(e="",t="\n",n=""):null==e&&(e="[\n",t="\n,\n",n="\n]\n");var u,i=!0,s=!1;return u=through(function(n){s=!0;var o=JSON.stringify(n,null,r);i?(i=!1,u.queue(e+o)):u.queue(t+o)},function(t){s||u.queue(e),u.queue(n),u.queue(null)})},exports.stringifyObject=function(e,t,n,r){r=r||0,e===!1?(e="",t="\n",n=""):null==e&&(e="{\n",t="\n,\n",n="\n}\n");var u=!0,i=!1,s=through(function(n){i=!0;var s=JSON.stringify(n[0])+":"+JSON.stringify(n[1],null,r);u?(u=!1,this.queue(e+s)):this.queue(t+s)},function(t){i||this.queue(e),this.queue(n),this.queue(null)});return s},module.parent||"browser"===process.title||process.stdin.pipe(exports.parse(process.argv[2])).pipe(exports.stringify("[",",\n","]\n",2)).pipe(process.stdout);